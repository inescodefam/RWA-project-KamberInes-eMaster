@model WebApp.Models.ProfessionalIndexVM

@{
    ViewData["Title"] = "Professional List";

}
@if (Model?.Professionals?.Count == 0)
{
    <div>No professionals found.</div>
}
<h2>Professionals List</h2>
@if (User.IsInRole("Admin"))
{   
<a asp-action="Create"
   asp-controller="Professional"
   class="btn btn-primary text-white mx-3 mt-3">
    Manage professionals
</a>
}
<div class="container py-4">
    <div class="card shadow-lg mb-5">
        <div class="card-header bg-primary text-white py-3">
            <h3 class="mb-0"><i class="bi bi-search me-2"></i>Search Professionals</h3>
        </div>
        <div class="card-body">
            <form id="searchProfessionalForm" 
                class="row g-3" 
                method="get" >
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" id="searchUsername" name="username" class="form-control" placeholder="Enter username" />
                        <label asp-for="Users" for="searchUsername"><i class="bi bi-person-fill me-2"></i>Username</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <select id="searchCityName" name="cityName" class="form-select">
                            <option value="">All cities</option>
                            @foreach (var city in Model.Cities)
                            {
                                <option value="@city.Text">@city.Text</option>
                            }
                        </select>
                        <label asp-for="Cities" for="searchCityName"><i class="bi bi-geo-alt-fill me-2"></i>City</label>
                    </div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary w-100 py-2">
                        <i class="bi bi-search me-2"></i>Search Professionals
                    </button>
                 
                </div>
            </form>
        </div>
    </div>

    <div id="professionalTableContainer">
        <partial name="_ProfessionalTablePartial" model="Model"/>
    </div>
</div>

@section Scripts {
    <script>

        $(document).ready(function() {

            $('#noResultsMessage').removeClass('d-none');

            $('#searchProfessionalForm').submit(function(e) {

                e.preventDefault();

                var username = $('#searchUsername').val();
                var cityName = $('#searchCityName').val();

                $.ajax({
                    url: '@Url.Action("Search", "Professional")',
                    type: 'GET',
                    data: {
                        username: username,
                        city: cityName,
                        pageSize: 100,
                        page: 0
                    },
                    success: function(results) {
                        console.log(results);
                        var professionals = results.professionals;
                        var $tbody = $('#professionalTableContainer #searchProfessionalsTable tbody');
                        $tbody.empty();

                        if (professionals && professionals.length > 0) {
                            $('#noResultsMessage').addClass('d-none');
                            $.each(professionals, function(i, p) {
                                $tbody.append(
                                    `<tr>
                                        <td>${p.userName || '-'}</td>
                                        <td>${p.cityNames.join(", ") || '-'}</td>
                                    </tr>`
                                );
                            });
                        } else {
                            $('#noResultsMessage').removeClass('d-none');
                        }
                    },
                    error: function(xhr) {
                        console.error('Search error:', xhr.responseText);
                        alert('Error searching professionals. Please try again.');
                    }
                }); 
            });

             $('#professionalTableContainer').on('click', '.page-ajax', function (e) {
            e.preventDefault();

            var page = $(this).data('page');
            var pageSize = $(this).data('pagesize');

            var username = $('#searchUsername').val();
            var cityName = $('#searchCityName').val();

            $.ajax({
                url: '@Url.Action("Search", "Professional")',
                type: 'GET',
                data: {
                    username,
                    city:cityName,
                    pageSize,
                    page,
                    partial: true
                },
                success: function (result) {
                    $('#professionalTableContainer').html(result);
                },
                error: function (xhr) {
                    console.error("Pagination AJAX error:", xhr.responseText);
                }
            });

        }); 
        })
    </script>
}


