@using WebApp.Models
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
@model WebApp.Models.ProfessionalIndexVM
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<script>
    $(document).ready(function() {
        $('#addProfessionalForm').submit(function(e) {
            e.preventDefault();

            var userId = $('#UserId').val();
                if (!userId || userId === "0") {
                $('#addProfessionalError').text('Please select a valid user.');
                return;
            }
            var cityIds = $('#CityIds').val();

            $.ajax({
                url: '@Url.Action("Create", "Professional")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                        UserId: userId,
                        CityIds: cityIds
                }),
                success: function(response) {
                    $('#professionalsTable tbody').load(window.location.href + ' #professionalsTable tbody>*', '');
                    $('#addProfessionalError').text('');
                },
                error: function(xhr) {
                    $('#addProfessionalError').text('Could not add professional: ' + xhr.responseText);
                }
            });
        });
        $(document).on('click', '.delete-professional', function() {
            var professionalId = $(this).data('id');
            var row = $(this).closest('tr');
            var deleteUrlTemplate = '@Url.Action("Delete", "Professional", new { id = "_id"})';

            if (confirm('Are you sure you want to delete this professional?')) {
                var deleteUrl = deleteUrlTemplate.replace('_id', professionalId);

                $.ajax({
                    url: deleteUrl,
                    type: 'DELETE',
                    success: function() {
                        row.fadeOut(300, function() {
                            $(this).remove();
                        });
                    },
                    error: function(xhr) {
                        alert('Error deleting professional: ' + xhr.responseText);
                    }
                });
            }
        });
    });
</script>

@if (User.Identity.IsAuthenticated && User.IsInRole("Admin"))
{
    <div class="container my-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Add Professional</h4>
            </div>
            <div class="card-body">
                <form id="addProfessionalForm" asp-action="Create" method="post" class="row g-3">
                    <div class="col-md-6">
                        <label for="UserId" class="form-label">User</label>
                        <select name="UserId" id="UserId" class="form-select">
                            <option value="">Select user</option>
                            @foreach (var user in Model.Users)
                            {
                                <option value="@user.Value">@user.Text</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="CityIds" class="form-label">City</label>
                        <select name="CityIds" id="CityIds" class="form-select" multiple>
                            @foreach (var city in Model.Cities)
                            {
                                <option value="@city.Value">@city.Text</option>
                            }
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-success">Add Professional</button>
                        <span id="addProfessionalError" class="text-danger ms-3"></span>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Professionals List</h5>
            </div>
            <div class="card-body p-0">
                <table id="professionalsTable" class="table table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Username</th>
                            <th>City</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Professionals != null)
                        {
                            foreach (var p in Model.Professionals)
                            {
                                <tr>
                                    <td>@p.UserName</td>
                                    <td>@string.Join(", ", p.CityNames ?? new List<string>())</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm delete-professional"
                                                data-id="@p.IdProfessional">
                                            Delete
                                        </button>
                                        <a class="btn btn-primary btn-sm" href="@Url.Action("Edit", "Professional", new { id = p.IdProfessional })">
                                            Edit
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

