@using WebApp.Models
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
   
}
@model WebApp.Models.ProfessionalIndexVM

@if (User.Identity.IsAuthenticated && User.IsInRole("Admin"))
{
    <div class="container my-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">Add Professional</h4>
            </div>
            <div class="card-body">
                <form id="addProfessionalForm" asp-action="Create" method="post" class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="Users" for="UserId" class="form-label"></label>
                        <select name="UserId" id="UserId" class="form-select">
                            <option value="">Select user</option>
                            @foreach (var user in Model.Users)
                            {
                                <option value="@user.Value">@user.Text</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Cities" for="CityIds" class="form-label"></label>
                        <select name="CityIds" id="CityIds" class="form-select" multiple>
                            @foreach (var city in Model.Cities)
                            {
                                <option value="@city.Value">@city.Text</option>
                            }
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-success">Add Professional</button>
                        <span id="addProfessionalError" class="text-danger ms-3"></span>
                    </div>
                </form>
            </div>
        </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">Delete Professional</h4>
                </div>
                <div class="card-body">
                <form id="deleteProfessionalForm" asp-action="DeleteProfessionalsForCity" asp-controller="CityProfessional" method="post" class="row g-3">
                        <div class="col-md-6 row mt-3">
                            <div class="col-auto align-items-center mt-1">
                            <label asp-for="Cities" for="id" class="form-label"></label>
                            </div>
                        <div class="col-5">
                            <select name="id" id="id" class="form-select">
                                @foreach (var city in Model.Cities)
                                {
                                    <option value="@city.Value">@city.Text</option>
                                }
                            </select>
                            </div>
                        </div>
                        <div class="col-md-2 mt-3">
                            <button type="submit" class="btn btn-danger">Delete Professionals</button>
                            <span id="deleteProfessionalError" class="text-danger ms-3"></span>
                        </div>
                </form>
                </div>
                </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Professionals List</h5>
            </div>
            <div class="card-body p-0 table-responsive">
                <table id="professionalsTable" class="table table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Username</th>
                            <th>City</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Professionals != null)
                        {
                            foreach (var p in Model.Professionals)
                            {
                                <tr>
                                    <td>@p.UserName</td>
                                    <td>@string.Join(", ", p.CityNames ?? new List<string>())</td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm delete-professional"
                                                data-id="@p.IdProfessional">
                                            Delete
                                        </button>
                                        <a class="btn btn-primary btn-sm" href="@Url.Action("Edit", "Professional", new { id = p.IdProfessional })">
                                            Edit
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <a asp-action="Index"
           asp-controller="Professional"
           class="btn btn-secondary text-white">
            Back
        </a>

    </div>
}
@section Scripts {
    <script>
        $(document).ready(function() {
            $('#addProfessionalForm').submit(function(e) {
                e.preventDefault();

                var userId = $('#UserId').val();
                    if (!userId || userId === "0") {
                    $('#addProfessionalError').text('Please select a valid user.');
                    return;
                }
                var cityIds = $('#CityIds').val();

                $.ajax({
                    url: '@Url.Action("Create", "Professional")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                            UserId: userId,
                            CityIds: cityIds
                    }),
                    success: function(response) {
                        $('#professionalsTable tbody').load(window.location.href + ' #professionalsTable tbody>*', '');
                        $('#addProfessionalError').text('');
                    },
                    error: function(xhr) {
                        $('#addProfessionalError').text('Professional already exsist.' + xhr.responseText);
                    }
                });
            });
            $(document).on('click', '.delete-professional', function() {
                var professionalId = $(this).data('id');
                var row = $(this).closest('tr');
                var deleteUrlTemplate = '@Url.Action("Delete", "Professional", new { id = "_id" })';

                if (confirm('Are you sure you want to delete this professional?')) {
                    var deleteUrl = deleteUrlTemplate.replace('_id', professionalId);

                    $.ajax({
                        url: deleteUrl,
                        type: 'POST',
                        success: function() {
                            row.fadeOut(300, function() {
                                $(this).remove();
                            });
                        },
                        error: function(xhr) {
                            alert('Error deleting professional: ' + xhr.responseText);
                        }
                    });
                }
            });

        });
    </script>
}
